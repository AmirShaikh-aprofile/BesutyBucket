<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeautyBucket Admin</title>
<style>
  body { font-family: Arial, sans-serif; background:#f8f5f5; padding:20px; }
  form { background:#fff; padding:20px; max-width:700px; margin:auto; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08) }
  input, select, textarea { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc }
  button { background:#d6336c; color:#fff; padding:12px; border:none; border-radius:6px; width:100% }
  .product-card { background:#fff; padding:12px; margin:12px 0; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,.06) }
  img.thumb { width:80px; height:80px; object-fit:cover; border-radius:6px; }
  .flex { display:flex; gap:12px }
  .flex > div { flex:1 }
</style>
</head>
<body>
<h2 style="text-align:center;color:#d6336c">BeautyBucket Admin Portal</h2>

<form id="productForm">
  <label>Product Name</label>
  <input name="name" required />

  <label>Category</label>
  <select name="category" required>
    <option value="">-- Select Category --</option>
  </select>
  <button type="button" onclick="addCategory()">+ Add Category</button>

  <label>Details</label>
  <textarea name="details" rows="2"></textarea>

  <div class="flex">
    <div>
      <label>MRP</label>
      <input type="number" step="0.01" name="mrp" required />
    </div>
    <div>
      <label>Our purchase price</label>
      <input type="number" step="0.01" name="purchase" />
    </div>
    <div>
      <label>Discount we got (%)</label>
      <input type="number" step="0.01" name="discount_mrp_percent" readonly />
    </div>
  </div>

  <div class="flex">
    <div>
      <label>Selling price (1 pc)</label>
      <input type="number" step="0.01" name="selling_price_1pc" />
    </div>
    <div>
      <label>Selling price (5 pc)</label>
      <input type="number" step="0.01" name="selling_price_5pc" />
    </div>
    <div>
      <label>Discount 1 pc (%)</label>
      <input type="number" step="0.01" name="discount_1pc_percent" readonly />
    </div>
    <div>
      <label>Discount 5 pc (%)</label>
      <input type="number" step="0.01" name="discount_5pc_percent" readonly />
    </div>
  </div>

  <label>Stock</label>
  <input type="number" name="stock" />

  <label>Image</label>
  <input type="file" name="image" accept="image/*" />

  <button type="submit">Add Product</button>
</form>

<h3 style="text-align:center;margin-top:24px">Existing Products</h3>
<div id="productsList" style="max-width:900px;margin:12px auto"></div>

<script>
const BASE = '/api';

// Load categories
async function loadCategories() {
  try {
    const res = await fetch(`${BASE}/categories`);
    const cats = await res.json();
    const sel = document.querySelector("select[name=category]");
    sel.innerHTML = '<option value="">-- Select Category --</option>';
    cats.forEach(c => {
      const o = document.createElement('option');
      o.value = c.name;
      o.textContent = c.name;
      sel.appendChild(o);
    });
  } catch (e) { console.error('loadCategories', e); }
}
loadCategories();

function addCategory() {
  const name = prompt("Enter new category name:");
  if(!name) return;
  fetch(`${BASE}/add-category`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({name})
  }).then(res=>res.json())
    .then(json=>{
      if(json.message) loadCategories();
      else alert(json.error || 'Error adding category');
    });
}

// Auto-calc discount we got %
document.querySelector("input[name=mrp]").addEventListener('input', calcDiscount);
document.querySelector("input[name=purchase]").addEventListener('input', calcDiscount);

function calcDiscount(){
  const mrp = parseFloat(document.querySelector("input[name=mrp]").value) || 0;
  const purchase = parseFloat(document.querySelector("input[name=purchase]").value) || 0;
  const disc = mrp ? ((mrp - purchase)/mrp*100).toFixed(2) : 0;
  document.querySelector("input[name=discount_mrp_percent]").value = disc;
}

// Auto-calc discount % from selling prices
function calcSellingDiscounts(){
  const mrp = parseFloat(document.querySelector("input[name=mrp]").value) || 0;
  const sp1 = parseFloat(document.querySelector("input[name=selling_price_1pc]").value) || 0;
  const sp5 = parseFloat(document.querySelector("input[name=selling_price_5pc]").value) || 0;
  const disc1 = mrp ? ((mrp - sp1)/mrp*100).toFixed(2) : 0;
  const disc5 = mrp ? ((mrp - sp5)/mrp*100).toFixed(2) : 0;
  document.querySelector("input[name=discount_1pc_percent]").value = disc1;
  document.querySelector("input[name=discount_5pc_percent]").value = disc5;
}

document.querySelector("input[name=selling_price_1pc]").addEventListener('input', calcSellingDiscounts);
document.querySelector("input[name=selling_price_5pc]").addEventListener('input', calcSellingDiscounts);

// Form submission
document.getElementById('productForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData(this);
  const action = this.getAttribute('data-action') || 'add';
  const url = action==='add'?`${BASE}/add-product`:`${BASE}/update-product/${this.getAttribute('data-id')}`;
  try {
    const res = await fetch(url,{method:'POST',body:fd});
    const json = await res.json();
    if(json.message){
      alert(json.message);
      this.reset();
      this.removeAttribute('data-action');
      this.removeAttribute('data-id');
      this.querySelector('button[type=submit]').textContent='Add Product';
      loadProducts();
      loadCategories();
    } else alert('Error: '+(json.error||JSON.stringify(json)));
  } catch(err){ alert('Request failed: '+err); console.error(err); }
});

// Load products
async function loadProducts(){
  try {
    const res = await fetch(`${BASE}/products`);
    const products = await res.json();
    const wrap = document.getElementById('productsList');
    wrap.innerHTML = '';
    products.forEach(p=>{
      const div = document.createElement('div');
      div.className='product-card';
      div.innerHTML=`
        <div style="display:flex;gap:12px;align-items:center">
          <img class="thumb" src="/images/${p.image_url||'Pic.jpg'}" />
          <div style="flex:1">
            <b>${p.name}</b> <small>(${p.category})</small><br>
            MRP: ₹${p.mrp} | Stock: ${p.stock}<br>
            Our Purchase Price: ₹${p.purchase_price} | Discount got: ${p.discount_mrp_percent}%<br>
            Selling 1pc: ₹${p.selling_price_1pc} (${p.discount_1pc_percent}%) | Selling 5pc: ₹${p.selling_price_5pc} (${p.discount_5pc_percent}%)
          </div>
          <div><button style="padding:4px 8px" onclick="editProduct(${p.id})">Edit</button></div>
        </div>`;
      wrap.appendChild(div);
    });
  } catch(e){ console.error('loadProducts', e); }
}
loadProducts();

async function editProduct(id){
  try {
    const res = await fetch(`/api/product/${id}`);
    const p = await res.json();
    const f = document.getElementById('productForm');
    f.name.value=p.name;
    f.category.value=p.category;
    f.details.value=p.details;
    f.mrp.value=p.mrp;
    f.purchase.value=p.purchase_price;
    f.discount_mrp_percent.value=p.discount_mrp_percent;
    f.selling_price_1pc.value=p.selling_price_1pc;
    f.selling_price_5pc.value=p.selling_price_5pc;
    f.discount_1pc_percent.value=p.discount_1pc_percent;
    f.discount_5pc_percent.value=p.discount_5pc_percent;
    f.stock.value=p.stock;
    f.querySelector('button[type=submit]').textContent='Update Product';
    f.setAttribute('data-action','update');
    f.setAttribute('data-id',id);
  } catch(e){ console.error('editProduct', e); }
}
</script>
</body>
</html>

